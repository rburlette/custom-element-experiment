<link rel="import" href="oo.html">
<link rel="import" href="ttt-board.html">
<template id="ttt-game">
    <style>
        :host {
            display: flex;
            margin: 20px;
        }

        .game-info {
            margin-left: 20px;
        }
    </style>

    <ttt-board [squares]="this.history[this.stepNumber]" [onsquareclick]="(e) => this.handleSquareClick(e)"></ttt-board>
    <div class="game-info">
        <div>{{this.statusMsg}}</div>
        <ol>
            <li data-rpt="this.history">
                <button [onclick]="(e) => this.jumpTo(context.index)">{{this.moveText(context.index)}}</button>
            </li>
        </ol>
    </div>
</template>

<script>
'use strict';

var tttGameTemplate = document.currentScript.ownerDocument.getElementById('ttt-game');

if (typeof ShadyCSS !== 'undefined') ShadyCSS.prepareTemplate(tttGameTemplate, 'ttt-game');

var tttGame = function (_ooElement) {
    _inherits(tttGame, _ooElement);

    function tttGame() {
        _classCallCheck(this, tttGame);

        return _possibleConstructorReturn(this, (tttGame.__proto__ || Object.getPrototypeOf(tttGame)).call(this, tttGameTemplate));
    }

    _createClass(tttGame, [{
        key: 'connectedCallback',
        value: function connectedCallback() {
            _get(tttGame.prototype.__proto__ || Object.getPrototypeOf(tttGame.prototype), 'connectedCallback', this).call(this);

            this.history = [[null, null, null, null, null, null, null, null, null]];

            this.stepNumber = 0;
            this.xIsNext = true;

            this.refresh();
        }
    }, {
        key: 'moveText',
        value: function moveText(index) {
            if (index === 0) return 'Go to game start';

            return 'Go to move #' + index;
        }
    }, {
        key: 'handleSquareClick',
        value: function handleSquareClick(i) {
            var currentSquares = this.history[this.stepNumber];

            if (this.calculateWinner(currentSquares) || currentSquares[i]) return;

            this.stepNumber++;

            this.history[this.stepNumber] = currentSquares.slice();

            this.history[this.stepNumber][i] = this.xIsNext ? "X" : "O";

            if (this.history.length - 1 > this.stepNumber) this.history = this.history.slice(0, this.stepNumber + 1);

            this.xIsNext = !this.xIsNext;

            this.refresh();
        }
    }, {
        key: 'jumpTo',
        value: function jumpTo(step) {
            this.stepNumber = step;
            this.xIsNext = step % 2 === 0;
            this.refresh();
        }
    }, {
        key: 'calculateWinner',
        value: function calculateWinner(squares) {
            var lines = [[0, 1, 2], [3, 4, 5], [6, 7, 8], [0, 3, 6], [1, 4, 7], [2, 5, 8], [0, 4, 8], [2, 4, 6]];
            for (var i = 0; i < lines.length; i++) {
                var _lines$i = _slicedToArray(lines[i], 3),
                    a = _lines$i[0],
                    b = _lines$i[1],
                    c = _lines$i[2];

                if (squares[a] && squares[a] === squares[b] && squares[a] === squares[c]) {
                    return squares[a];
                }
            }
            return null;
        }
    }, {
        key: 'statusMsg',
        get: function get() {
            var winner = this.calculateWinner(this.history[this.stepNumber]);

            if (winner) return "Winner: " + winner;

            return "Next player: " + (this.xIsNext ? "X" : "O");
        }
    }]);

    return tttGame;
}(ooElement);

customElements.define('ttt-game', tttGame);
</script>