<link rel="import" href="oo.html">
<link rel="import" href="ttt-board.html">
<template id="ttt-game">
    <style>
        :host {
            display: flex;
            margin: 20px;
        }

        .game-info {
            margin-left: 20px;
        }
    </style>

    <ttt-board [squares]="this.currentBoard" [onsquareclick]="(i) => this.handleSquareClick(i)"></ttt-board>
    <div class="game-info">
        <div>{{this.statusMsg}}</div>
        <ol>
            <li data-rpt="this.state.history">
                <button [onclick]="(e) => this.jumpTo(context.index)">{{this.moveText(context.index)}}</button>
            </li>
        </ol>
    </div>
</template>

<script>
    const tttGameTemplate = document.currentScript.ownerDocument.getElementById('ttt-game');

    class tttGame extends ooElement {
        constructor() {
            super(tttGameTemplate);

            this.setState({
                history: [
                    {
                    squares: Array(9).fill(null)
                    }
                ],
                stepNumber: 0,
                xIsNext: true
            });
        }

        moveText(index) {
            return index ? 'Go to move #' + index : 'Go to game start';
        } 

        get currentBoard() {
            return this.state.history[this.state.stepNumber].squares;
        } 

        handleSquareClick(i) {
            const history = this.state.history.slice(0, this.state.stepNumber + 1);
            const current = history[history.length - 1];
            const squares = current.squares.slice();
            
            if (this.calculateWinner(squares) || squares[i]) {
                return;
            }
            
            squares[i] = this.state.xIsNext ? "X" : "O";
            
            this.setState({
                history: history.concat([
                    { 
                        squares: squares 
                    }
                ]),
                stepNumber: history.length,
                xIsNext: !this.state.xIsNext
            });
        }

        jumpTo(step) {
            this.setState({
                history: this.state.history,
                stepNumber: step,
                xIsNext: (step % 2) === 0
            });
        }

        setState(state) {
            this.state = state;
            this.refresh();
        }

        get statusMsg() {
            let winner = this.calculateWinner(this.currentBoard);
            
            if (winner) {
                return "Winner: " + winner;
            } else {
                return "Next player: " + (this.state.xIsNext ? "X" : "O");
            }
        }

        calculateWinner(squares) {
            const lines = [
                [0, 1, 2],
                [3, 4, 5],
                [6, 7, 8],
                [0, 3, 6],
                [1, 4, 7],
                [2, 5, 8],
                [0, 4, 8],
                [2, 4, 6]
            ];
            for (let i = 0; i < lines.length; i++) {
                const [a, b, c] = lines[i];
                if (squares[a] && squares[a] === squares[b] && squares[a] === squares[c]) {
                    return squares[a];
                }
            }
            return null;
        }
    }

    customElements.define('ttt-game', tttGame);
</script>