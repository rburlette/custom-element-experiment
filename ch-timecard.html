<link rel="import" href="oo.html">

<template id="ch-timecard">
    <style>
        :host, table {
            width: 100%;
        }

        input[type="text"] {
            width: 80px;
        }

        ul {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }
        
        label { 
            display: block;
            font-size: 12px;
        }
        
        table {
            border-collapse: collapse;
        }

        th, td {
            border: 1px solid lightgrey;
        }

        td {
            vertical-align: top;
        }

        tr:last-child {
            text-align: center;
            vertical-align: middle;
        }

        .flex-lr {
            display: flex;
            justify-content: space-between;
            margin: 4px;
        }

        .companion {
            border: 1px solid rgb(48, 166, 245);
            background-color: #dbedf5;
            border-radius: 2px;
        }

        .personal {
            border: 1px solid rgb(38, 163, 90);
            background-color: #baf8d4;
            border-radius: 2px;
        }

        .home {
            border: 1px solid rgb(77, 87, 228);
            background-color: #d1d1ff;
            border-radius: 2px;
        }

        .changed { 
            border-color: red;
        }

        .date-header {
            font-size: 12px;
        }

        .insert {
            display: block;
            width: 100%;
            background: #ffffff;
            border: 1px dotted lightgrey;
            min-height: 8px;

            border-radius: 2px;
            margin: 1px 0;
        }

        .insert:hover {
            border: 1px dotted grey;
        }

        .insert:hover::after {
            content: '+ Add New';
        }

        .insert:active {
            border: 1px dotted black;
        }

        .insert:focus {
            outline: 0;
            border: 1px dotted blue;
        }

        .service {
            background-color: inherit;
            color: inherit;
            border: none;
            width: 100%;
            border-bottom: 1px solid;
            font-weight: bold;
            font-size: 12px;
        }

        .service:disabled {
            -webkit-appearance: none;
        }

        .footer {
            color: rgb(255, 255, 255);
            background: #00000047;
            font-size: 11px;
            font-weight: bold;
        }

        .close {
            margin: 0 0 0 4px;
            font-size: 9px;
            padding: 1px 4px 0px 4px;
        }

    </style>
    <table>
        <tr>
            <th oo-rpt='state.days'>{{item.day}}</th>
        </tr>
        <tr>
            <th oo-rpt='state.days' class="date-header">{{item.date.toLocaleDateString()}}  ({{this.totalHours(item)}} hours)</th>
        </tr>
        <tr>
            <td oo-rpt='state.days'>
                <button class="insert" [onclick]="(e) => this.addNewJob(item, -1)"></button>

                <ul>
                    <li oo-rpt='item.jobs'>
                        <div [class]="this.jobClass(item)">
                            <div class="flex-lr">
                                <select class="service" [value]='item.service' [disabled]="!(item.isNew)" [oninput]='(e) => this.changeService(item, e.target.value)'>
                                    <option oo-rpt='state.services' [value]="item.value">{{item.name}}</option>
                                </select>
                                <button class="close" [onclick]="(e) => this.removeJob(context)" oo-show="item.isNew">X</button>    
                            </div>
                            
                            <div class="flex-lr">
                                <label>In:</label>
                                <select [value]="item.in.toJSON()" [oninput]='(e) => this.changeIn(item, e.target.value)' [class]="this.inClass(item)">
                                    <option oo-rpt="context.parent.item.times" [value]="item.value">{{item.text}}</option>
                                </select>
                            </div>

                            <div class="flex-lr">
                                <label>Out:</label>
                                <select [value]="item.out.toJSON()" [oninput]='(e) => this.changeOut(item, e.target.value)' [class]="this.outClass(item)">
                                    <option oo-rpt="context.parent.item.times" [value]="item.value">{{item.text}}</option>
                                </select>
                            </div>
                            <div class="footer">
                                {{this.getDuration(item)}} hours
                            </div>   
                        </div>
                        <button class="insert" [onclick]="(e) => this.addNewJob(context.parent.item, context.index)"></button>
                    </li>
                </ul>
            </td>
        </tr>
    </table>
</template>

<script>
    const myAppTemplate = document.currentScript.ownerDocument.getElementById('ch-timecard');

    customElements.define('ch-timecard', class extends ooElement {
        constructor() {
            super(myAppTemplate);

            this.setState({
                services: [
                    { name: 'Companion', value: 1 },
                    { name: 'Homemaker', value: 2 },
                    { name: 'Personal Care', value: 3 }
                ],
                days: [
                    {
                        day: 'Sunday',
                        date: new Date(2018, 6, 3),
                        times: this.getTimes(new Date(2018, 6, 3)),
                        jobs:[
                            { 
                                service: 1,
                                in: new Date(2018, 6, 3, 3, 15),
                                out: new Date(2018, 6, 3, 4, 45)
                            },
                            { 
                                service: 2,
                                in: new Date(2018, 6, 3, 4, 45),
                                out: new Date(2018, 6, 3, 6)
                            }
                        ]
                    },
                    {
                        day: 'Monday',
                        date: new Date(2018, 6, 4),
                        times: this.getTimes(new Date(2018, 6, 4)),
                        jobs:[
                            { 
                                service: 3,
                                in: new Date(2018, 6, 4, 3, 15),
                                out: new Date(2018, 6, 4, 4, 45)
                            },
                            { 
                                service: 1,
                                in: new Date(2018, 6, 4, 4, 45),
                                out: new Date(2018, 6, 4, 6)
                            }
                        ]
                    },
                    {
                        day: 'Tuesday',
                        date: new Date(2018, 6, 5),
                        times: this.getTimes(new Date(2018, 6, 5)),
                        jobs:[
                            { 
                                service: 3,
                                in: new Date(2018, 6, 5, 3, 15),
                                out: new Date(2018, 6, 5, 4, 45)
                            },
                            { 
                                service: 3,
                                in: new Date(2018, 6, 5, 4, 45),
                                out: new Date(2018, 6, 5, 6)
                            }
                        ]
                    },
                    {
                        day: 'Wednesday',
                        date: new Date(2018, 6, 6),
                        times: this.getTimes(new Date(2018, 6, 6)),
                        jobs:[
                            { 
                                service: 2,
                                in: new Date(2018, 6, 6, 4, 45),
                                out: new Date(2018, 6, 6, 6)
                            }
                        ]
                    },
                    {
                        day: 'Thursday',
                        date: new Date(2018, 6, 7),
                        times: this.getTimes(new Date(2018, 6, 7)),
                        jobs:[
                            { 
                                service: 1,
                                in: new Date(2018, 6, 7, 3, 15),
                                out: new Date(2018, 6, 7, 4, 45)
                            },
                            { 
                                service: 1,
                                in: new Date(2018, 6, 7, 4, 45),
                                out: new Date(2018, 6, 7, 6)
                            }
                        ]
                    },
                    {
                        day: 'Friday',
                        date: new Date(2018, 6, 8),
                        times: this.getTimes(new Date(2018, 6, 8)),
                        jobs:[
                            { 
                                service: 2,
                                in: new Date(2018, 6, 8, 3, 15),
                                out: new Date(2018, 6, 8, 4, 45)
                            }
                        ]
                    },
                    {
                        day: 'Saturday',
                        date: new Date(2018, 6, 9),
                        times: this.getTimes(new Date(2018, 6, 9)),
                        jobs:[
                            { 
                                service: 3,
                                in: new Date(2018, 6, 9, 3, 15),
                                out: new Date(2018, 6, 9, 4, 45)
                            },
                            { 
                                service: 2,
                                in: new Date(2018, 6, 9, 3, 15),
                                out: new Date(2018, 6, 9, 4, 45)
                            }
                        ]
                    }

                ]
            });
        }

        getTimes(currentDate) {
            let myDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), currentDate.getDate());

            let dateNum = myDay.getDate();

            let times = [];

            while(myDay.getDate() === dateNum) {
                times.push({
                    text: myDay.toLocaleString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true }),
                    value: myDay.toJSON()
                });

                myDay.setMinutes(myDay.getMinutes() + 15);
            }

            times.push({
                text: 'End of Day',
                value: myDay.toJSON()
            });

            return times;
        }

        addNewJob(day, index) {
            day.jobs.splice(index + 1, 0, { 
                service: 2,
                in: new Date(day.date),
                out: new Date(day.date),
                isNew: true
            });
            
            let evalCount = this.boundRoot.refresh();
            
            console.log('Eval Count: ' + evalCount);
        }

        removeJob(context) {
            context.parent.item.jobs.splice(context.index, 1);
            this.boundRoot.refresh();
        }

        changeService(item, value) {
            item.service = value;
            this.boundRoot.refresh();
        }

        changeIn(item, value) {
            if(!item.prevIn)
                item.prevIn = item.in;

            item.in = new Date(value);

            this.boundRoot.refresh();
        }

        changeOut(item, value) {
            if(!item.prevOut)
                item.prevOut = item.out;

            item.out = new Date(value);
            this.boundRoot.refresh();
        }

        inClass(item){
            if(item.isNew || (item.prevIn && item.in.getTime() !== item.prevIn.getTime()))
                return 'changed';
        }

        outClass(item) {
            if(item.isNew || (item.prevOut && item.out.getTime() !== item.prevOut.getTime()))
                return 'changed';
        }

        jobClass(item) {
            return ['companion', 'personal', 'home'][item.service - 1];
        }

        getDuration(item) {
            return Math.abs(item.out - item.in) / 36e5;
        }

        totalHours(day) {
            return day.jobs.reduce((total, job) => { return total + this.getDuration(job) }, 0);
        }
    });

</script>