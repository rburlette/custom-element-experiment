<link rel="import" href="oo.html">

<template id="ch-timecard">
    <style>
        :host, table {
            width: 100%;
        }

        input[type="text"] {
            width: 80px;
        }

        ul {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }

        li {
            margin: 4px 0;
        }

        li.is-new {
            border: 1px solid #ff9900;
        }
        
        label { 
            display: block;
            font-size: 12px;
        }
        
        table {
            border-collapse: collapse;
        }

        th, td {
            border: 1px solid lightgrey;
        }

        td {
            vertical-align: top;
            padding: 0 4px;
        }

        tr:last-child {
            text-align: center;
            vertical-align: middle;
        }

        .flex-lr {
            display: flex;
            justify-content: space-between;
            margin: 4px;
        }

        .companion {
            border: 1px solid rgb(48, 166, 245);
            background-color: #dbedf5;
            border-radius: 2px;
        }

        .personal {
            border: 1px solid rgb(38, 163, 90);
            background-color: #baf8d4;
            border-radius: 2px;
        }

        .home {
            border: 1px solid rgb(77, 87, 228);
            background-color: #d1d1ff;
            border-radius: 2px;
        }
        
        select {
            background: #ffffff;
            border: 1px solid lightgrey;
        }

        .changed { 
            background: yellow;
        }

        .date-header {
            font-size: 12px;
        }

        .service {
            background-color: inherit;
            color: inherit;
            border: none;
            width: 100%;
            border-bottom: 1px solid;
            font-weight: bold;
            font-size: 12px;
        }

        .service:disabled {
            -webkit-appearance: none;
        }

        .footer {
            color: rgb(255, 255, 255);
            background: rgb(0, 0, 0, .28);
            font-size: 11px;
            font-weight: bold;
        }

        .close {
            margin: 0 0 0 4px;
            font-size: 9px;
            padding: 1px 4px 0px 4px;
            display: none;
        }

        .is-new .close {
            display: block;
        }

        .add-new {
            font-size: 12px;
            display: block;
            width: 100%;
            margin: 4px 0;
        }

    </style>
    <table>
        <tr>
            <th oo-rpt='this.days'>{{item.day}}</th>
        </tr>
        <tr>
            <th oo-rpt='this.days' class="date-header">{{item.date.toLocaleDateString()}}  ({{this.totalHours(item)}} hours)</th>
        </tr>
        <tr>
            <td oo-rpt='this.days'>
                <ul>
                    <li oo-rpt='item.jobs' [class]="this.jobClass(item)">
                        <div class="flex-lr">
                            <select class="service" [value]='item.service' [disabled]="!(item.isNew)" [onchange]='(e) => this.changeService(item, e.target.value)'>
                                <option oo-rpt='this.services' [value]="item.value">{{item.name}}</option>
                            </select>
                            <button class="close" [onclick]="(e) => this.removeJob(context)">X</button>    
                        </div>
                        
                        <div class="flex-lr">
                            <label>Payer:</label>
                            <select [value]="item.payerId" [disabled]="!(item.isNew)" [onchange]='(e) => this.changePayer(item, e.target.value)'>
                                <option oo-rpt="this.payers" [value]="item.value">{{item.name}}</option>
                            </select>
                        </div>

                        <div class="flex-lr">
                            <label>In:</label>
                            <select [value]="item.in.toJSON()" [onchange]='(e) => this.changeIn(item, e.target.value)' [class]="this.inClass(item)">
                                <option oo-rpt="context.parent.item.times" [value]="item.value">{{item.text}}</option>
                            </select>
                        </div>

                        <div class="flex-lr">
                            <label>Out:</label>
                            <select [value]="item.out.toJSON()" [onchange]='(e) => this.changeOut(item, e.target.value)' [class]="this.outClass(item)">
                                <option oo-rpt="context.parent.item.times" [value]="item.value">{{item.text}}</option>
                            </select>
                        </div>
                        <div class="footer">
                            {{this.getDuration(item)}} hours
                        </div>   
                    </li>
                </ul>
                <button class="add-new" [onclick]="(e) => this.addNewJob(item)">+ Add New</button>
            </td>
        </tr>
    </table>
</template>

<script>
    const myAppTemplate = document.currentScript.ownerDocument.getElementById('ch-timecard');

    customElements.define('ch-timecard', class extends ooElement {
        constructor() {
            super(myAppTemplate);

            this.services = [
                { name: 'Companion', value: 1 },
                { name: 'Homemaker', value: 2 },
                { name: 'Personal Care', value: 3 }
            ];
            
            this.payers = [
                { name: 'Elena Rodriquez', value: 1 },
                { name: 'BCBS Insurance', value: 2 },
                { name: 'C & H', value: 3 }
            ]
            
            this.days =  [
                {
                    day: 'Sunday',
                    date: new Date(2018, 6, 3),
                    times: this.getTimes(new Date(2018, 6, 3)),
                    jobs:[
                        { 
                            service: 1,
                            payerId: 2,
                            in: new Date(2018, 6, 3, 3, 15),
                            out: new Date(2018, 6, 3, 4, 45)
                        },
                        { 
                            service: 2,
                            payerId: 2,
                            in: new Date(2018, 6, 3, 4, 45),
                            out: new Date(2018, 6, 3, 6)
                        }
                    ]
                },
                {
                    day: 'Monday',
                    date: new Date(2018, 6, 4),
                    times: this.getTimes(new Date(2018, 6, 4)),
                    jobs:[
                        { 
                            service: 3,
                            payerId: 2,
                            in: new Date(2018, 6, 4, 3, 15),
                            out: new Date(2018, 6, 4, 4, 45)
                        },
                        { 
                            service: 1,
                            payerId: 2,
                            in: new Date(2018, 6, 4, 4, 45),
                            out: new Date(2018, 6, 4, 6)
                        }
                    ]
                },
                {
                    day: 'Tuesday',
                    date: new Date(2018, 6, 5),
                    times: this.getTimes(new Date(2018, 6, 5)),
                    jobs:[
                        { 
                            service: 3,
                            payerId: 2,
                            in: new Date(2018, 6, 5, 3, 15),
                            out: new Date(2018, 6, 5, 4, 45)
                        },
                        { 
                            service: 3,
                            payerId: 2,
                            in: new Date(2018, 6, 5, 4, 45),
                            out: new Date(2018, 6, 5, 6)
                        }
                    ]
                },
                {
                    day: 'Wednesday',
                    date: new Date(2018, 6, 6),
                    times: this.getTimes(new Date(2018, 6, 6)),
                    jobs:[
                        { 
                            service: 2,
                            payerId: 2,
                            in: new Date(2018, 6, 6, 4, 45),
                            out: new Date(2018, 6, 6, 6)
                        }
                    ]
                },
                {
                    day: 'Thursday',
                    date: new Date(2018, 6, 7),
                    times: this.getTimes(new Date(2018, 6, 7)),
                    jobs:[
                        { 
                            service: 1,
                            payerId: 2,
                            in: new Date(2018, 6, 7, 3, 15),
                            out: new Date(2018, 6, 7, 4, 45)
                        },
                        { 
                            service: 1,
                            payerId: 2,
                            in: new Date(2018, 6, 7, 4, 45),
                            out: new Date(2018, 6, 7, 6)
                        }
                    ]
                },
                {
                    day: 'Friday',
                    date: new Date(2018, 6, 8),
                    times: this.getTimes(new Date(2018, 6, 8)),
                    jobs:[
                        { 
                            service: 2,
                            payerId: 2,
                            in: new Date(2018, 6, 8, 3, 15),
                            out: new Date(2018, 6, 8, 4, 45)
                        }
                    ]
                },
                {
                    day: 'Saturday',
                    date: new Date(2018, 6, 9),
                    times: this.getTimes(new Date(2018, 6, 9)),
                    jobs:[
                        { 
                            service: 3,
                            payerId: 2,
                            in: new Date(2018, 6, 9, 3, 15),
                            out: new Date(2018, 6, 9, 4, 45)
                        },
                        { 
                            service: 2,
                            payerId: 2,
                            in: new Date(2018, 6, 9, 3, 15),
                            out: new Date(2018, 6, 9, 4, 45)
                        }
                    ]
                }

            ];

            this.boundRoot.refresh();
        }

        getTimes(currentDate) {
            let myDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), currentDate.getDate());

            let dateNum = myDay.getDate();

            let times = [];

            while(myDay.getDate() === dateNum) {
                times.push({
                    text: myDay.toLocaleString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true }),
                    value: myDay.toJSON()
                });

                myDay.setMinutes(myDay.getMinutes() + 15);
            }

            times.push({
                text: 'End of Day',
                value: myDay.toJSON()
            });

            return times;
        }

        addNewJob(day) {
            day.jobs.push({ 
                service: 2,
                payerId: 2,
                in: new Date(day.date),
                out: new Date(day.date),
                isNew: true
            });
            
            let evalCount = this.boundRoot.refresh();
            
            console.log('Eval Count: ' + evalCount);
        }

        removeJob(context) {
            context.parent.item.jobs.splice(context.index, 1);
            this.boundRoot.refresh();
        }

        changeService(item, value) {
            item.service = value;
            this.boundRoot.refresh();
        }

        changePayer(item, value) {
            item.payerId = value;
        }

        changeIn(item, value) {
            if(!item.prevIn)
                item.prevIn = item.in;

            item.in = new Date(value);

            this.boundRoot.refresh();
        }

        changeOut(item, value) {
            if(!item.prevOut)
                item.prevOut = item.out;

            item.out = new Date(value);
            this.boundRoot.refresh();
        }

        inClass(item){
            if(item.isNew || (item.prevIn && item.in.getTime() !== item.prevIn.getTime()))
                return 'changed';
        }

        outClass(item) {
            if(item.isNew || (item.prevOut && item.out.getTime() !== item.prevOut.getTime()))
                return 'changed';
        }

        jobClass(item) {
            let myClass =  ['companion', 'personal', 'home'][item.service - 1];
            if(item.isNew)
                myClass += ' is-new';

            return myClass;
        }

        getDuration(item) {
            return Math.abs(item.out - item.in) / 36e5;
        }

        totalHours(day) {
            return day.jobs.reduce((total, job) => { return total + this.getDuration(job) }, 0);
        }
    });
</script>