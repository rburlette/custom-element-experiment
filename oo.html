<script>
    class ooElement extends HTMLElement {
        constructor(template) {
            super(); // always call super() first in the ctor.

            if(template) {
                let shadowRoot = this.attachShadow({ mode: 'open' });
                shadowRoot.appendChild(template.content.cloneNode(true));
                this.initialize(shadowRoot);
            }
        }

        setState(data) {
            this.state = data;
            this.stringBinders.forEach(this.processStringBinder);
        }

        initialize(shadowRoot) {
            this.stringBinders = [];

            let currentNode;

            let walker = this.buildTreeWalker(shadowRoot);

            while(currentNode = walker.nextNode()){
                switch(currentNode.nodeType) {
                    case 3:
                        this.bindTextNode(currentNode);
                        break;
                    case 1:
                        this.bindAttributes(currentNode);
                        break;
                }
            }
        }

        buildTreeWalker(element) {
            return document.createTreeWalker(
                element,
                NodeFilter.SHOW_TEXT | NodeFilter.SHOW_ELEMENT,
                {
                    acceptNode: function(node) {
                        switch(node.nodeName) {
                            case 'STYLE':
                            case 'SCRIPT':
                                return NodeFilter.FILTER_REJECT;
                            default:
                                return NodeFilter.FILTER_ACCEPT;
                        }   
                    }
                },
                false);
        }

        processStringBinder(stringBinder) {
            let stringModified = false;
                
            stringBinder.functions.forEach(function(func){
                let previousValue = stringBinder.strings[func.index];

                try { stringBinder.strings[func.index] = func.evalFunction(); }
                catch(err) { stringBinder.strings[func.index] = ""; }

                if(stringBinder.strings[func.index] !== previousValue)
                    stringModified = true;
            });

            if(stringModified) {
                stringBinder.applyChange(stringBinder.strings.join(''));
            }
        }
 
        bindAttributes(element) {
            for(let i = 0; i < element.attributes.length; i++) {
                this.createStringBinder(element.attributes[i].value,
                {
                    element: element,
                    attributeName: element.attributes[i].nodeName,
                    applyChange: function(newString) {
                        this.element.setAttribute(this.attributeName, newString);
                    }
                });
            }
        }

        bindTextNode(node) {
            this.createStringBinder(node.nodeValue,
            {
                node: node,
                applyChange: function(newString) {
                    this.node.nodeValue = newString;
                }
            });
        }

        createStringBinder(inputString, result, applyChange) {
            let match;
            let prevIndex = 0;
            let pattern = /{{\s*([^}]+)\s*}}/g;
            
            result.strings = [];
            result.functions = [];
            
            while(match = pattern.exec(inputString)) {

                if(match.index !== prevIndex) {
                    result.strings.push(inputString.substring(prevIndex, match.index));
                }
                
                result.strings.push(null);
                
                result.functions.push({
                    evalFunction: Function('return (' + match[1] + ');').bind(this),
                    index: result.strings.length - 1
                });
                
                prevIndex = pattern.lastIndex;
            }

            if(result.functions.length > 0) { 
                
                if(prevIndex < inputString.length) {
                    result.strings.push(inputString.substring(prevIndex, inputString.length));
                }

                this.stringBinders.push(result);
            }
        }
    }
</script>